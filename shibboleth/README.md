`curl -sk https://idp.dev.local:8444/idp/shibboleth | grep -o 'entityID="[^"]*"' | head -1`
curl -sk https://localhost:8443/saml/sp/metadata/sp > regapp-sp.xml
docker cp regapp-sp.xml shib-idp-dev:/opt/shibboleth-idp/metadata/regapp-sp.xml


docker network create saml-dev
docker run -d --name shib-idp-dev --network saml-dev shib-idp-dev
Now the IdP is reachable only inside Docker as shib-idp-dev:443.

### run ldap
```
docker run -d --name openldap --network shibdev \
  -e LDAP_DOMAIN=dev.local \
  -e LDAP_ADMIN_PASSWORD=admin \
  -p 389:389 -p 636:636 \
  docker.io/osixia/openldap:1.5.0
```

### Pick hostname
Pick a dev FQDN for cookies + SAML sanity, e.g.:
- IdP: idp.dev.local
- SP (RegApp): regapp.dev.local

Map them to your machine/ingress IP:
```sh
sudo bash -c 'cat >>/etc/hosts <<EOF
127.0.0.1  idp.dev.local regapp.dev.local
EOF'
```


### Generate IdP config tree
```sh
mkdir -p $PWD/shibdev
pushd $PWD/shibdev
# run interactively and answer prompts:
# IdP hostname: idp.dev.local
# entityID: https://idp.dev.local/idp/shibboleth
# scope: dev.local
# ldap://openldap:389
# base dn: dc=dev,dc=local
# dn: cn=admin,dc=dev,dc=local
docker run --rm -it --network shibdev -e BUILD_ENV=LINUX -v "$PWD:/output:Z" i2incommon/shibbidp_configbuilder_container:latest
popd

mkdir -p shibdev/config/shib-idp/conf/authn
cp -v shibdev/idp/conf/authn/htpasswd.txt shibdev/config/shib-idp/conf/authn/htpasswd.txt
```


### Create test users (no LDAP): htpasswd file
```sh
mkdir -p $PWD/shibdev/idp/conf/authn
htpasswd -c -m $PWD/shibdev/idp/conf/authn/htpasswd.txt alice
htpasswd    -m $PWD/shibdev/idp/conf/authn/htpasswd.txt bob
```

edit conf/authn/password-authn-config.xml and set:
shibdev/config/shib-idp/conf/authn/password-authn-config.xml
```xml
<util:list id="shibboleth.authn.Password.Validators">
  <bean parent="shibboleth.HTPasswdValidator" p:resource="%{idp.home}/conf/authn/htpasswd.txt" />
  <bean parent="shibboleth.HTPasswdCredentialValidator" p:resource="%{idp.home}/conf/authn/htpasswd.txt" />
</util:list>
```


build the image generated by config generator?
cd shibdev
docker build -t shib-idp-dev .
docker run -d --name shib-idp-dev -p 8444:443 shib-idp-dev
sudo docker run -d --name shib-idp-dev -p 443:443 shib-idp-dev
docker exec -it shib-idp-dev bash
cd /opt/shibboleth-idp/bin/./module.sh -t idp.authn.Password || ./module.sh -e idp.authn.Password
exit
check https://idp.dev.local:8444/idp/shibboleth
https://localhost:8444/idp/profile/admin/hello

enable password module
```
docker exec -it shib-idp /bin/bash
cd /opt/shibboleth-idp
bin/module.sh -t idp.authn.Password || true
bin/module.sh -e idp.authn.Password
exit
```

### Register the RegApp metadata in metadata-providers.xml
edit shibdev/config/shib-idp/conf/metadata-providers.xml:
add a filesystem provider entry (name/id can be anything)
```xml
<MetadataProvider id="RegAppSP" xsi:type="FilesystemMetadataProvider"
    metadataFile="%{idp.home}/metadata/regapp-sp.xml"
    failFastInitialization="true" />
```
cp regapp-sp.xml shibdev/config/shib-idp/metadata/
cp access-control.xml shibdev/config/shib-idp/conf/
rebuild container:
docker rm -f shib-idp-dev
docker build --no-cache -t shib-idp-dev ./shibdev/
#docker run -d --name shib-idp-dev -p 8444:443 shib-idp-dev
docker run -d --name shib-idp-dev -p 443:443 shib-idp-dev


### fake attribs
with StaticDataConnector + AttributreDefinitions in `conf/attribute-resolver.xml`
- eduPersonPrincipalName (alice@dev.local)
- mail
- displayName
- givenName
- sn
- eduPersonScopedAffiliation (member@dev.local)

### load RegApp SP metadata into the IdP
download the metadata XML (http://localhost:8443/saml/sp/metadata/TestSP)
place it into the IdPs `metadata/` directory (`metadata/regapp.xml`
add a filesystem metadata provider entry pointing at it in `conf/metadata-providers.xml`


### Fix TLS in regapp:
```
cd containers/dev
echo | openssl s_client -connect idp.dev.local:443 2>/dev/null \
  | openssl x509 -outform PEM > idp-dev.crt
keytool -importcert -noprompt -alias idp-dev \
  -file idp-dev.crt \
  -keystore regapp-truststore.jks \
  -storepass changeit \
  -storetype JKS
```
update regapp compose.yaml:
```yaml
services:
  reg-app:
    ...
    volumes:
      - ./regapp-truststore.jks:/opt/regapp/truststore.jks:ro,z
    environment:
      - TZ=Europe/Berlin
      ...
      - 'JAVA_OPTS=-Xmx2G -Djavax.net.ssl.trustStore=/opt/regapp/truststore.jks -Djavax.net.ssl.trustStorePassword=changeit'
```
docker compose -f ... up --build





